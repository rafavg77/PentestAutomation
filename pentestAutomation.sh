#/bin/bash
#!/bin/bash -       

#title			    :pentestAutomation
#description    :This script automate reconnaissance and service detection with namp
#author		 	    :@rafavg77
#date           :27/10/2019
#version        :0.1    
#usage		 	    :./pentestAutomation.sh
#notes          :Install nmap and searchsploit

IP=$1
OUTPUT_DIR="output"
API_KEY=""
CHAT_ID=""

check(){

	## Valida que la variable IP no estÃ© vacia 
	if [ -z "$IP" ]
	then
		echo "[+] $IP adress is empty"
		exit 1
	else
		echo "[+] Init Pentsting to $IP"
	fi

	## Valida que el directorio output exista en caso contrario se crea
	if [ -d $OUTPUT_DIR ]
	then
		echo "Directory $OUTPUT_DIR exists."
	else
		mkdir $OUTPUT_DIR
	fi
}

## Execute tcp ports discovery to single IP
reconnaissance(){
	sendMessage $IP "[*] Iniciando Pentest en IP"
	echo "[+] Excuting reconnaissance phase ... "
	nmap -v -p- -T5 $IP -oA $OUTPUT_DIR/$IP
	getServiceVersions $IP
}

## Get services with agressive scan to TCP ports
getServiceVersions(){
	IP=$1
	PORTS=$(grep open $OUTPUT_DIR/$IP.nmap | awk '{ print $1}' | cut -d'/' -f1 | xargs | sed -e 's/ /,/g')

	echo "[+] Get service and description ... "
	nmap -v -sC -sV -p $PORTS -A $IP -oA $OUTPUT_DIR/$IP"_agressive"
	getVulns $IP
}

getVulns(){
	IP=$1
	PORTS=$(grep open $OUTPUT_DIR/$IP.nmap | awk '{ print $1}' | cut -d'/' -f1 | xargs | sed -e 's/ /,/g')
	SERVICES=$(grep open $OUTPUT_DIR/$(echo $IP)_agressive.nmap | awk '{ print $4}' | sort -r | uniq | awk '{print tolower($0)}' | sed '/^[[:space:]]*$/d')

	echo "[+] Vulnerability identificaction phase ..."
	# for SERVICE in $SERVICES; do
	# 	echo "[+] Searching scripts for $SERVICE"
	# 	GET_SCRIPT=$(ls -la /usr/share/nmap/scripts/*$SERVICE* | grep "No such file or directory")
	# 	if [[ -z "$GET_SCRIPT" ]]; 
	# 	then
	# 	 	echo "[+] Executing Scripts for service $SERVICE in $IP" 
	# 	 	#nmap -v -sV --script *$SERVICE* $IP
	# 	else
	# 		echo "[+] No script found for service $SERVICE"
	# 	fi
	# done
	echo "[+] Run nmap Exploits scripts " 
	nmap -v -sV -p $PORTS --script exploit $IP -oA $OUTPUT_DIR/$IP"_vulns"
	echo ""
	echo "[+] Searching Exploits for service $SERVICE" 
	echo ""
	searchsploit -v --nmap $OUTPUT_DIR/$IP"_agressive.xml"

	sendMessage $IP "[+] Pentest Terminado en IP"
	echo "[*] Pentest to $IP is done"

}

sendMessage(){
	IP=$1
	TEXT=$2
	if [ -z "$API_KEY" ]; then
		echo "[+] API_KEY is empty"
	else
		if [ -z "$CHAT_ID" ]; then
			echo "[+] CHAT_ID is empty"	
		else
			curl -s -X POST https://api.telegram.org/bot$API_KEY/sendMessage -d chat_id=$CHAT_ID -d text="$TEXT $IP" > /dev/null
		fi
	fi	
}

getExploits(){
	SERVICE=$1
	echo "[+] Searching Exploits for service $SERVICE"
	searchsploit $SERVICE
}

run(){
	check
	reconnaissance
}

run
